#!/bin/bash

###############################################################################
# Emergency Ubuntu Server Cleanup Script
# For when the server is too slow to SSH into manually
###############################################################################

set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration - UPDATE THESE!
SERVER_USER="your-username"
SERVER_HOST="your-server-ip"
SSH_PORT="22"

echo -e "${RED}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║        EMERGENCY UBUNTU SERVER CLEANUP SCRIPT             ║${NC}"
echo -e "${RED}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

# Check if sshpass is installed
if ! command -v sshpass &> /dev/null; then
    echo -e "${YELLOW}⚠️  sshpass not found. Installing...${NC}"
    if [[ "$OSTYPE" == "darwin"* ]]; then
        brew install hudochenkov/sshpass/sshpass
    else
        echo "Please install sshpass manually: brew install hudochenkov/sshpass/sshpass"
        exit 1
    fi
fi

# Prompt for password (or use SSH key if available)
echo -e "${BLUE}Enter SSH password for ${SERVER_USER}@${SERVER_HOST}:${NC}"
read -s SSH_PASSWORD
echo ""

# SSH options for aggressive timeouts
SSH_OPTS="-o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=2 -o StrictHostKeyChecking=no"

echo -e "${YELLOW}Attempting emergency connection...${NC}"

# Function to run SSH command with timeout
run_ssh() {
    local cmd="$1"
    local desc="$2"

    echo -e "\n${BLUE}▶ ${desc}${NC}"

    if [ -z "$SSH_PASSWORD" ]; then
        # Use SSH key if no password
        timeout 30 ssh $SSH_OPTS -p "$SSH_PORT" "${SERVER_USER}@${SERVER_HOST}" "$cmd" 2>&1
    else
        # Use sshpass if password provided
        timeout 30 sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p "$SSH_PORT" "${SERVER_USER}@${SERVER_HOST}" "$cmd" 2>&1
    fi

    local exit_code=$?
    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}✅ Success${NC}"
    elif [ $exit_code -eq 124 ]; then
        echo -e "${RED}❌ Timeout (30s)${NC}"
    else
        echo -e "${RED}❌ Failed (exit code: $exit_code)${NC}"
    fi
    return $exit_code
}

# Emergency Operations

echo -e "\n${RED}═══════════════════════════════════════════════════════════${NC}"
echo -e "${RED}Phase 1: Quick Diagnostics${NC}"
echo -e "${RED}═══════════════════════════════════════════════════════════${NC}"

run_ssh "uptime" "Check server uptime and load"
run_ssh "free -h" "Check memory usage"
run_ssh "df -h /" "Check disk usage"

echo -e "\n${RED}═══════════════════════════════════════════════════════════${NC}"
echo -e "${RED}Phase 2: Emergency Cleanup${NC}"
echo -e "${RED}═══════════════════════════════════════════════════════════${NC}"

# Kill Ollama if consuming too much memory
run_ssh "sudo pkill -9 ollama || true" "Force kill Ollama service"

# Restart Docker (this will restart OpenWebUI)
run_ssh "sudo systemctl restart docker || true" "Restart Docker service"

# Clear system cache
run_ssh "sudo sync && sudo sysctl -w vm.drop_caches=3 || true" "Clear system caches"

# Kill zombie processes
run_ssh "ps aux | grep 'defunct' | awk '{print \$2}' | xargs -r sudo kill -9 2>/dev/null || true" "Kill zombie processes"

echo -e "\n${RED}═══════════════════════════════════════════════════════════${NC}"
echo -e "${RED}Phase 3: Service Management${NC}"
echo -e "${RED}═══════════════════════════════════════════════════════════${NC}"

# Check if services are up
run_ssh "sudo systemctl is-active ollama || echo 'Ollama not running'" "Check Ollama status"
run_ssh "sudo systemctl is-active nginx || echo 'Nginx not running'" "Check Nginx status"
run_ssh "docker ps --format 'table {{.Names}}\t{{.Status}}' || echo 'Docker not responding'" "Check Docker containers"

echo -e "\n${RED}═══════════════════════════════════════════════════════════${NC}"
echo -e "${RED}Phase 4: Start Critical Services${NC}"
echo -e "${RED}═══════════════════════════════════════════════════════════${NC}"

# Start Ollama with memory limits
run_ssh "sudo systemctl start ollama || true" "Start Ollama service"

# Start nginx
run_ssh "sudo systemctl start nginx || true" "Start Nginx"

# Start OpenWebUI container
run_ssh "docker start openwebui 2>/dev/null || echo 'OpenWebUI container not found'" "Start OpenWebUI container"

echo -e "\n${RED}═══════════════════════════════════════════════════════════${NC}"
echo -e "${RED}Final Status Check${NC}"
echo -e "${RED}═══════════════════════════════════════════════════════════${NC}"

run_ssh "uptime" "Current load"
run_ssh "free -h" "Memory status"
run_ssh "systemctl is-active ollama nginx docker" "Service status"

echo -e "\n${GREEN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Emergency cleanup complete!${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"

echo -e "\n${YELLOW}If the server is still unresponsive, you may need to:${NC}"
echo -e "  1. Reboot from your hosting provider's control panel"
echo -e "  2. Access the console/VNC from your provider"
echo -e "  3. Contact support to investigate hardware issues"
echo ""

# Offer to reboot
echo -e "${RED}Do you want to REBOOT the server now? (y/N):${NC}"
read -r REBOOT_CONFIRM

if [[ "$REBOOT_CONFIRM" =~ ^[Yy]$ ]]; then
    echo -e "${RED}⚠️  REBOOTING SERVER...${NC}"
    run_ssh "sudo reboot" "Reboot server" || echo "Reboot command sent (connection will drop)"
    echo -e "${YELLOW}Server is rebooting. Wait 1-2 minutes before attempting to reconnect.${NC}"
fi
