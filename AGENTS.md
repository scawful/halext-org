# Halext Org Server Field Guide

This server hosts multiple legacy PHP sites alongside the Halext Org FastAPI + React stack. Use this guide when triaging incidents so you can jump directly to the right files and commands.

## Key Paths & Services

- **Repo root**: `/srv/halext.org/halext-org` (Git tree)
  - Backend: `/srv/halext.org/halext-org/backend`
  - Frontend: `/srv/halext.org/halext-org/frontend`
  - Infra assets: `/srv/halext.org/halext-org/infra/ubuntu`
  - Scripts: `/srv/halext.org/halext-org/scripts`
- **Live SPA files**: `/var/www/halext` (synced from `frontend/dist` during deploys)
- **Legacy sites**: `/www/<domain>/public`
- **Nginx config roots**:
  - Global: `/etc/nginx/nginx.conf`
  - Common snippets: `/etc/nginx/global.conf`, `/etc/nginx/ssl/*.conf`, `/etc/nginx/php/*.conf`
  - Virtual hosts: `/etc/nginx/sites/*.conf` (included directly from `nginx.conf`)
- **Systemd service**: `halext-api.service` runs Uvicorn on `127.0.0.1:8000`
- **Logs**:
  - Nginx: `/var/log/nginx/access.log` + `/var/log/nginx/error.log`
  - Backend: `journalctl -u halext-api -f`

## Deploy / Recovery Workflow

1. **Pull latest code**
   ```bash
   cd /srv/halext.org/halext-org
   git status
   git pull
   ```
2. **Backend install / migrations**
   ```bash
   cd backend
   source env/bin/activate
   pip install -r requirements.txt
   alembic upgrade head   # if migrations land later
   ```
3. **Frontend build + sync**
   ```bash
   cd frontend
   npm install
   npm run build
   sudo rsync -a --delete dist/ /var/www/halext/
   sudo chown -R www-data:www-data /var/www/halext
   ```
4. **Nginx + service check**
   ```bash
   sudo systemctl restart halext-api
   sudo nginx -t && sudo systemctl reload nginx
   ```

Use `./scripts/setup-org.sh` on a fresh box or to re-template nginx/units. For incremental updates `./scripts/server-deploy.sh` (in `scripts/`) handles the same steps automatically.

## Quick Commands

- **`nginxctl` helper** (defined in `~/.bashrc`):
  - `nginxctl test | reload | restart`
  - `nginxctl errors 200` – tail last 200 lines
  - `nginxctl host org.halext.org [https]` – probes a vhost locally through 127.0.0.1
  - `nginxctl config` – dumps effective config via `nginx -T`
- **Check backend health**: `systemctl status halext-api` then `journalctl -u halext-api -n 100`
- **Verify database**: `sudo -u postgres psql -c '\l'` (DB: `halext_org`, user: `halext_user`)
- **Diagnose script output**: `/tmp/halext-diagnostic-<timestamp>.log` is generated by `scripts/setup-org.sh --diagnostic`

## Common Issues & Fixes

- **403 on org.halext.org root** – Usually means Certbot dropped default blocks into `/etc/nginx/nginx.conf`. Ensure only `sites/org.halext.org.conf` defines that host and rerun `sudo nginx -t && sudo systemctl reload nginx`.
- **Frontend API “NetworkError”** – Confirm `frontend/src/App.tsx` defaults to `window.location.origin + '/api'` and rebuild/rsync the SPA. Browser mixed-content blocks occur if it falls back to `http://127.0.0.1:8000`.
- **Permission denied during `npm run build`** – Fix ownership on `frontend/node_modules/.tmp`, `.vite-temp`, and `frontend/dist` (chown back to `justin:halext`).
- **Busy hunters hitting `.env` files** – `/etc/nginx/global.conf` now denies dotfiles globally. If you add a new server file, simply `include global.conf` to inherit the block.

## Verifying Services

Run these when closing out incidents:

```bash
curl -Ik -H 'Host: org.halext.org' https://127.0.0.1     # SPA served
curl -I -H 'Host: org.halext.org' http://127.0.0.1/api/users/ \
  -H 'X-Halext-Code: <code>' --data '{"username":"probe",...}'  # registration path
```

`halext-api` seeds layout presets on startup. If you ever reset the DB, restart the service after migrations so the presets repopulate.

## Notes for Future Agents

- Certs are managed via `certbot --nginx`; outputs live under `/etc/letsencrypt/live/<domain>` and are re-used via `/etc/nginx/ssl/<domain>.conf` snippets.
- Legacy hosts (e.g., `freeforyallclt.com`) are intentionally retired with `410 Gone`. Don’t resurrect them unless Justin explicitly asks.
- Access to the API is gated by `ACCESS_CODE` (current value lives in `backend/.env`). Ensure frontend changes keep the `X-Halext-Code` header on POST `/users/`.
- Keep `~/bin/nginx-helper` up to date if you add new operational tasks; its function is sourced via `.bashrc` so every shell inherits it.
